好的，这是基于您提供的 Python 代码编写的用户手册。

---

# 电子书视频生成器 - 用户手册

## 1. 目标和范围

* **功能定位与业务背景:**
    本工具是一个自动化脚本，旨在根据用户提供的结构化故事描述（JSON 文件），结合对应的音频旁白和 OpenAI DALL-E 生成的图像，自动合成一个 MP4 格式的视频。主要用于快速将简单的故事、电子书章节、教学内容或概念原型转化为可视化视频。
* **目标用户:**
    * 内容创作者（如博主、作家、教育工作者）
    * 需要快速制作简单动画或演示视频的用户
    * 希望将文本和音频内容自动转换为视频格式的开发者或小型团队
* **使用场景:**
    * 将儿童读物或短篇故事制作成带配图和旁白的视频。
    * 为在线课程或教程创建简单的视觉辅助材料。
    * 快速生成产品介绍或概念演示的视频原型。
    * 将博客文章或播客片段转化为更具吸引力的视频格式。
* **适用环境:**
    * 运行 Python 的命令行环境。
    * 支持的操作系统：Linux, macOS, Windows (建议通过 WSL 或确保 `ffmpeg` 在系统 PATH 中)。
    * 需要稳定的网络连接以访问 OpenAI API。

## 2. 前置条件

* **环境需求:**
    * **Python:** 需要安装 Python 3.7 或更高版本。
    * **FFmpeg:** 必须安装 `ffmpeg` 命令行工具，并且其路径需要添加到系统的环境变量 `PATH` 中，以便脚本可以调用它。你可以通过在终端或命令提示符运行 `ffmpeg -version` 来检查是否安装成功。
    * **Python 库:** 需要安装 `openai` 库。可以通过 pip 安装：`pip install openai`。
* **权限要求:**
    * **文件系统:** 对脚本所在的目录、`story.json` 文件、音频文件、`TEMP_DIR` 临时目录以及最终视频输出目录具有读写权限。
    * **网络:** 需要访问 `api.openai.com` 以使用图像生成服务。
    * **OpenAI API 密钥:** 必须拥有一个有效的 OpenAI API 密钥，并有足够的配额或余额来使用图像生成模型 (如 DALL-E 3)。
* **配置项及默认值:**
    脚本顶部的常量定义了核心配置：
    * `STORY_JSON_FILE = "story.json"`: 输入的故事描述文件名。
    * `TEMP_DIR = "temp_video_files"`: 存放临时图片和视频片段的目录名。
    * `SEGMENTS_FILE_NAME = "segments.txt"`: `ffmpeg` 合并视频时使用的片段列表文件名（位于 `TEMP_DIR` 内）。
    * `FINAL_VIDEO_NAME = "ebook_video.mp4"`: 最终生成的视频文件名。
    * `VIDEO_WIDTH = 1280`: 输出视频的宽度（像素）。
    * `VIDEO_HEIGHT = 720`: 输出视频的高度（像素）。
    * `IMAGE_SIZE = "1024x1024"`: 请求 OpenAI 生成的图片尺寸。注意：这会被缩放/填充以适应 `VIDEO_WIDTH`x`VIDEO_HEIGHT`。
    * `IMAGE_MODEL = "gpt-image-1"`: 用于生成图片的 OpenAI 模型。**注意：** 如果此模型不可用或报错（特别是 "invalid_model" 错误），请尝试将其更改为 `"dall-e-3"`。
    * `IMAGE_STYLE_PROMPT = ", 吉卜力漫画风格, 包含中文对话框"`: 附加到每个场景图像提示后的风格描述。
    * **环境变量 `OPENAI_API_KEY`**: **(关键配置)** 脚本启动时会读取此环境变量来验证 OpenAI API 访问权限。**必须在运行脚本前设置此环境变量。**

## 3. 安装与部署

1.  **安装 Python:** 如果尚未安装，请从 [python.org](https://www.python.org/) 下载并安装适合您操作系统的 Python 3.7+ 版本。
2.  **安装 FFmpeg:**
    * 访问 [ffmpeg.org](https://ffmpeg.org/download.html) 获取适用于您操作系统的版本。
    * 按照官方指南进行安装。
    * **重要:** 确保将 `ffmpeg` 的可执行文件路径添加到系统的 `PATH` 环境变量中。验证方法：打开新的终端/命令提示符窗口，输入 `ffmpeg -version` 并回车，应能看到版本信息。
3.  **安装 Python 依赖:** 打开终端或命令提示符，运行以下命令：
    ```bash
    pip install openai
    ```
4.  **获取 OpenAI API 密钥:** 访问您的 [OpenAI 账户](https://platform.openai.com/account/api-keys) 创建或获取 API 密钥。
5.  **设置 OpenAI API 密钥环境变量:**
    * **Linux/macOS:**
        ```bash
        export OPENAI_API_KEY='你的_API_密钥'
        # 为了永久生效，可以将其添加到 .bashrc, .zshrc 或 .profile 文件中
        ```
    * **Windows (命令提示符):**
        ```cmd
        set OPENAI_API_KEY=你的_API_密钥
        ```
    * **Windows (PowerShell):**
        ```powershell
        $env:OPENAI_API_KEY = "你的_API_密钥"
        ```
    * **注意:** 关闭并重新打开终端/命令提示符窗口以使环境变量生效。**强烈建议不要将 API 密钥直接写入脚本中。**
6.  **准备脚本和输入文件:**
    * 将 Python 脚本文件（例如 `video_generator.py`）保存到您的工作目录。
    * 在该目录下创建 `story.json` 文件，并按照指定格式填充内容（详见“使用说明”）。
    * 将 `story.json` 中引用的所有音频文件（如 `.mp3`, `.wav`, `.m4a` 等，确保 FFmpeg 支持）放置在相应的位置（可以是相对路径或绝对路径）。
7.  **部署完成:** 现在您可以运行该脚本了。

## 4. 使用说明

1.  **准备 `story.json` 文件:**
    这是脚本的核心输入。它必须是一个 JSON 列表，其中每个元素代表视频的一个场景（一个对象）。每个场景对象应至少包含以下两个键：
    * `audio_file` (字符串): 指向该场景对应的音频文件的路径（相对脚本运行目录或绝对路径）。
    * `image_prompt` (字符串): 用于向 OpenAI DALL-E 请求生成该场景图像的文本提示。脚本会自动在末尾添加 `IMAGE_STYLE_PROMPT`。
    * `scene_title` (字符串, 可选): 场景的标题，用于日志输出，方便调试。如果缺少，会使用默认标题 "场景 X"。

    **`story.json` 示例:**
    ```json
    [
      {
        "scene_title": "开场白",
        "audio_file": "audio/scene1_intro.mp3",
        "image_prompt": "一个安静的图书馆角落，阳光透过窗户洒进来"
      },
      {
        "scene_title": "遇到小精灵",
        "audio_file": "audio/scene2_elf.wav",
        "image_prompt": "一个好奇的小男孩在森林里发现了一个发光的小精灵"
      },
      {
        "scene_title": "获得魔法书",
        "audio_file": "relative/path/to/scene3_book.m4a",
        "image_prompt": "小精灵递给小男孩一本古老的、闪烁着微光的魔法书"
      }
    ]
    ```
2.  **确保音频文件就位:** 确认 `story.json` 中 `audio_file` 指向的所有音频文件都存在于指定路径。
3.  **运行脚本:**
    打开设置好环境变量的终端或命令提示符，切换到包含脚本和 `story.json` 的目录，然后运行：
    ```bash
    python your_script_name.py
    ```
    (将 `your_script_name.py` 替换为您的实际脚本文件名)
4.  **监控过程:** 脚本会依次执行以下步骤，并在控制台打印日志信息：
    * 检查 `ffmpeg` 是否可用。
    * 初始化 OpenAI 客户端（检查 API 密钥）。
    * 读取并验证 `story.json`。
    * 创建临时目录 `temp_video_files`。
    * 循环处理每个场景：
        * 检查音频文件是否存在。
        * 调用 OpenAI API 生成图片 (可能需要一些时间)。
        * 使用 `ffmpeg` 将图片和音频合并为视频片段。
    * 将所有成功生成的片段路径写入 `segments.txt`。
    * 使用 `ffmpeg` 合并所有片段为最终视频 `ebook_video.mp4`。
    * 如果一切顺利，删除临时目录 `temp_video_files`。
5.  **获取结果:**
    * 如果脚本成功完成，您将在脚本运行目录下找到最终的视频文件 `ebook_video.mp4`。
    * 如果中途出错，脚本会停止，并保留 `temp_video_files` 目录及其中的文件（已生成的图片、视频片段、`segments.txt` 文件），以便您检查错误原因。

## 5. 错误处理与故障恢复

脚本内置了一些错误检查机制，常见的错误及其处理方式如下：

* **`错误: 未找到 ffmpeg...`**:
    * **原因:** `ffmpeg` 未安装或其路径未添加到系统环境变量 `PATH`。
    * **解决:** 安装 `ffmpeg` 并确保其在 `PATH` 中。在新的终端窗口中运行 `ffmpeg -version` 进行验证。
* **`错误：无法初始化 OpenAI 客户端... 请确保 OPENAI_API_KEY 环境变量已设置...`**:
    * **原因:** 未设置 `OPENAI_API_KEY` 环境变量，或者设置不正确/未生效。
    * **解决:** 按照“安装与部署”部分的说明正确设置 `OPENAI_API_KEY` 环境变量，并确保在运行脚本的同一终端会话中生效。
* **`错误: 故事文件 story.json 未找到。`**:
    * **原因:** `story.json` 文件不在脚本运行的当前目录下，或文件名不匹配。
    * **解决:** 确认 `story.json` 文件存在于运行脚本的目录，且文件名无误。
* **`错误: 解析 story.json 时出错...`**:
    * **原因:** `story.json` 文件内容不是有效的 JSON 格式（例如，括号不匹配、缺少逗号、引号使用错误等）。
    * **解决:** 使用 JSON 校验工具检查 `story.json` 的语法，修正错误。确保它是一个包含对象的列表 `[{}, {}, ...]`。
* **`警告：场景 X 缺少 'audio_file' 或 'image_prompt'...`**:
    * **原因:** `story.json` 中某个场景对象缺少必要的键。
    * **解决:** 检查 `story.json` 文件，确保每个场景都有 `audio_file` 和 `image_prompt` 键及其对应的值。脚本会跳过有问题的场景。
* **`错误：场景 X 的音频文件 'path/to/audio.mp3' 未找到...`**:
    * **原因:** `story.json` 中指定的音频文件路径无效或文件不存在。
    * **解决:** 检查 `audio_file` 路径是否正确（相对路径是相对于脚本运行目录），并确保音频文件确实存在于该位置。
* **`错误：调用 OpenAI API 时出错...` 或 `错误：生成图片时发生未知错误...`**:
    * **原因:** 可能包括：API 密钥无效或过期、网络连接问题、OpenAI 服务中断、请求的图像模型 (`IMAGE_MODEL`) 无效或账户不支持、提示内容违反 OpenAI 政策、账户余额不足等。
    * **解决:**
        * 检查网络连接。
        * 确认 API 密钥有效且账户状态正常。
        * 查看 OpenAI 服务状态页面。
        * **如果错误信息包含 "invalid_model" 或类似提示，尝试将脚本中的 `IMAGE_MODEL` 更改为 `"dall-e-3"`。**
        * 检查 `image_prompt` 是否合规。
        * 检查详细错误信息（状态码、响应内容）以获取更多线索。
* **`错误：执行 ffmpeg 命令失败...` 或 `错误：创建/合并视频片段时发生未知错误...`**:
    * **原因:** `ffmpeg` 执行过程中出错。可能是音频文件格式不受支持、文件损坏、磁盘空间不足、权限问题，或者 `ffmpeg` 命令参数有误（脚本内部问题）。
    * **解决:**
        * 检查 `ffmpeg` 打印的错误输出（`错误输出: ...`）。
        * 确保音频文件可以正常播放，尝试转换为常用格式如 MP3 或 AAC。
        * 确保输出目录有足够的磁盘空间和写入权限。
        * 查看临时目录 (`TEMP_DIR`) 中的文件，特别是 `segments.txt` 和已生成的片段。

* **故障恢复:**
    * 如果脚本因错误中断，它会停止处理并**保留 `temp_video_files` 目录**。
    * **检查控制台输出**，找到最后一条错误信息，确定问题所在。
    * **检查 `temp_video_files` 目录**：查看已生成的图片 (`.png`) 和视频片段 (`.mp4`)，以及 `segments.txt` 文件（如果已生成），这有助于定位问题发生在哪个场景。
    * **修复问题**：根据错误信息采取相应措施（例如，修正 `story.json`、替换损坏的音频文件、检查 API 密钥、更改 `IMAGE_MODEL` 等）。
    * **重新运行脚本**：修复问题后，可以再次运行脚本。脚本会重新开始整个过程（注意：如果之前的临时文件未手动删除，可能会被覆盖）。

## 6. 安全与权限

* **OpenAI API 密钥安全:**
    * **绝对不要**将您的 OpenAI API 密钥直接硬编码在脚本中或提交到公共代码仓库（如 GitHub）。
    * 使用**环境变量** (`OPENAI_API_KEY`) 是推荐的做法，可以隔离密钥与代码。
    * 保护好您的 API 密钥，如同保护密码一样，防止未授权访问和使用。定期轮换密钥可以增加安全性。
* **文件系统权限:**
    * 脚本需要对工作目录、临时目录和输出文件位置具有读写权限。确保运行脚本的用户拥有这些权限。
    * 注意 `story.json` 中引用的音频文件路径，脚本需要读取这些文件的权限。
* **输入内容安全:**
    * 您提供的 `image_prompt` 会发送给 OpenAI。确保提示内容符合 OpenAI 的使用政策，不包含非法、有害或侵犯版权的内容。
    * 音频文件的内容也应是您拥有使用权或符合许可协议的。
* **依赖项安全:**
    * 脚本依赖于 `openai` Python 库和 `ffmpeg` 外部工具。请确保从官方或可信赖的来源获取这些软件，以避免潜在的安全风险（如恶意软件）。定期更新依赖库也是一个好习惯。

## 7. 附录

### 术语表

* **API (Application Programming Interface):** 应用程序编程接口，允许不同软件之间进行交互。这里指 OpenAI API，用于访问其 AI 模型。
* **API Key:** 用于验证应用程序或用户身份以访问 API 的唯一代码字符串。
* **DALL-E:** OpenAI 开发的 AI 模型，可以根据文本描述生成图像。脚本中使用它来创建场景图片。
* **FFmpeg:** 一个强大的开源多媒体框架，能够处理音频、视频的解码、编码、转码、合并、流式传输等。脚本用它来创建视频片段和合并最终视频。
* **JSON (JavaScript Object Notation):** 一种轻量级的数据交换格式，易于人阅读和编写，也易于机器解析和生成。`story.json` 使用此格式。
* **Scene:** 视频中的一个片段，通常由一张静态图片和一段对应的音频组成。在 `story.json` 中用一个 JSON 对象表示。
* **Segment:** 指由单个场景（一张图片 + 一段音频）生成的短视频文件（`.mp4`）。
* **Concatenation:** 将多个视频片段（Segments）按顺序拼接成一个完整的长视频的过程。
* **Environment Variable:** 操作系统中存储的配置值，可以在程序运行时被访问。`OPENAI_API_KEY` 就是通过环境变量设置的。
* **Prompt:** 提供给 AI 模型（如 DALL-E）的输入文本，用于指导其生成所需内容（这里是图片）。
* **PATH (Environment Variable):** 一个特殊的环境变量，包含操作系统搜索可执行文件的目录列表。需要将 `ffmpeg` 的路径加入 `PATH`。
* **Temporary Directory (`TEMP_DIR`):** 脚本运行时用于存放中间文件（图片、视频片段、列表文件）的文件夹。成功完成后会被删除。

### FAQ (常见问题)

* **Q1: 如何更改输出视频的分辨率？**
    * A1: 编辑脚本开头的 `VIDEO_WIDTH` 和 `VIDEO_HEIGHT` 常量为你想要的分辨率（例如 `1920` 和 `1080`）。注意，图像生成尺寸 (`IMAGE_SIZE`) 可能也需要相应调整或了解其会被缩放/填充。
* **Q2: 如何改变生成的图片风格？**
    * A2: 修改脚本开头的 `IMAGE_STYLE_PROMPT` 字符串。你可以移除或替换 `" 吉卜力漫画风格, 包含中文对话框"` 为你想要的风格描述（例如 `", photorealistic"` 或 `", watercolor painting"`）。
* **Q3: 图片生成失败，提示 "invalid_model" 或类似错误？**
    * A3: 这通常意味着脚本中配置的 `IMAGE_MODEL`（默认为 `"gpt-image-1"`）对您的账户不可用或已被 OpenAI 更改。尝试将 `IMAGE_MODEL` 的值修改为 `"dall-e-3"`，这是目前（截至编写时）推荐且广泛可用的模型。
* **Q4: 我可以使用 `.wav` 或 `.m4a` 格式的音频文件吗？**
    * A4: 可以。脚本使用 `ffmpeg` 处理音频，`ffmpeg` 支持多种音频格式。只要你的 `ffmpeg` 版本支持该格式的解码，脚本就能处理。最终视频中的音频会被编码为 AAC 格式 (`-c:a aac`)。
* **Q5: 脚本运行失败后，那些临时文件有什么用？**
    * A5: 临时文件位于 `temp_video_files` 目录。检查其中的 `.png` 图片可以看图像生成是否符合预期；检查 `.mp4` 片段可以看单个场景的视频生成情况；`segments.txt`（如果生成了）显示了哪些片段准备被合并。这些文件有助于诊断问题出在哪个环节或哪个场景。
* **Q6: 使用 OpenAI 生成图片会收费吗？**
    * A6: 是的。调用 OpenAI API 生成图片通常会根据图片的分辨率、质量和使用的模型计费。请查阅 OpenAI 的最新定价页面了解详情，并确保您的账户有足够余额或信用额度。
* **Q7: 脚本总是提示 "ffmpeg not found" 怎么办？**
    * A7: 确认您已经正确安装了 `ffmpeg`，并且它的安装路径（包含 `ffmpeg` 可执行文件的目录）已经添加到了您操作系统的 `PATH` 环境变量中。关闭并重新打开命令行/终端窗口后再次尝试。
* **Q8: 脚本提示 `OPENAI_API_KEY` 未设置怎么办？**
    * A8: 确保你已经在运行脚本的终端/命令提示符环境中正确设置了名为 `OPENAI_API_KEY` 的环境变量，其值为你有效的 OpenAI API 密钥。具体设置方法见“安装与部署”第 5 步。

---