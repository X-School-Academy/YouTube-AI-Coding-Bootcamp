By Gemini 2.5 Pro

好的，下面是针对 `create_ebook_video.sh` 脚本的用户手册和测试验收流程。

---

## create_ebook_video.sh 用户手册

**版本:** 1.0
**日期:** 2025-04-24

**1. 简介**

`create_ebook_video.sh` 是一个 Linux Shell 脚本，旨在使用 FFmpeg 工具将一系列静态图片文件与其对应的音频文件合并，生成一个连续播放的视频文件。每个图片将作为一“页”，显示的时长由其对应的音频文件决定。这对于创建简单的视频电子书、带配音的演示文稿或图片故事非常有用。

**2. 系统要求与依赖**

* **操作系统:** 任何现代 Linux 发行版 (例如 Ubuntu, Fedora, Debian, CentOS, Arch Linux 等)。
* **Shell 环境:** `bash` (Bourne Again SHell)。脚本使用 `#!/bin/bash` 指定，并可能包含 `bash` 特有的语法（如数组）。虽然某些部分可能在其他 Shell (如 `zsh`) 中运行，但推荐在 `bash` 环境下执行。
* **核心软件:** `ffmpeg`。这是进行音视频处理的关键工具。脚本依赖于 `ffmpeg` 命令及其常用选项。
* **其他工具:** 脚本使用了标准的 Linux 命令行工具，如 `echo`, `rm`, `seq`, `chmod`。这些通常在所有 Linux 发行版中都默认安装。
* **硬件:** 对 CPU 和内存有一定要求，尤其是在处理高分辨率图片或长音频时。磁盘空间需要足够存储临时视频片段和最终的输出视频。

**3. 安装与准备**

* **安装 FFmpeg:**
    * 检查是否已安装：在终端输入 `ffmpeg -version`。如果显示版本信息，则已安装。
    * 安装（如果需要）：
        * Debian/Ubuntu: `sudo apt update && sudo apt install ffmpeg`
        * Fedora: `sudo dnf install ffmpeg`
        * CentOS/RHEL (可能需要 EPEL/RPM Fusion 仓库): `sudo yum install ffmpeg` 或 `sudo dnf install ffmpeg`
* **准备媒体文件:**
    * **图片文件:** 准备好你想使用的图片文件 (支持 `.jpg`, `.png`, `.jpeg`, `.bmp` 等常见静态图片格式)。
    * **音频文件:** 准备好与图片一一对应的音频文件 (推荐 `.mp3`，但 `ffmpeg` 通常也支持 `.wav`, `.aac`, `.ogg` 等)。
    * **命名与排序:** 确保图片和音频文件**按顺序**配对。脚本默认配置使用 `image1.jpg`, `image2.jpg`, ... 和 `audio1.mp3`, `audio2.mp3`, ... 的命名方式。如果你使用不同的文件名，需要在脚本中进行配置。
    * **存放位置:** 将所有的图片文件、音频文件和 `create_ebook_video.sh` 脚本文件放在**同一个目录下**。
* **脚本权限:**
    * 将脚本代码保存为文件，例如 `create_ebook_video.sh`。
    * 在终端中，使用 `cd` 命令进入该目录。
    * 赋予脚本执行权限： `chmod +x create_ebook_video.sh`

**4. 配置脚本**

打开 `create_ebook_video.sh` 文件，你可以修改脚本开头的配置部分：

```bash
# --- 配置 ---
# 图片文件列表 (确保顺序与音频文件对应)
IMAGES=("image1.jpg" "image2.png" "image3.jpeg" "image4.jpg" "image5.gif") # 示例：可使用不同扩展名
# 音频文件列表 (确保顺序与图片文件对应)
AUDIO_FILES=("audio1.mp3" "audio2.mp3" "audio3.mp3" "audio4.mp3" "audio5.mp3")
# 输出的最终视频文件名
OUTPUT_VIDEO="ebook_video.mp4"
# --- （以下通常无需修改）---
# 用于合并的临时文件列表名
LIST_FILE="mylist.txt"
# 临时视频片段文件名的前缀
SEGMENT_PREFIX="segment_"
```

* **`IMAGES=(...)`**: 在括号内按顺序列出你的图片文件名，用空格分隔。确保文件名包含正确的扩展名。
* **`AUDIO_FILES=(...)`**: 在括号内按顺序列出与图片对应的音频文件名，用空格分隔。**此列表的长度必须与 `IMAGES` 列表的长度相同**。
* **`OUTPUT_VIDEO="..."`**: 设置你希望生成的最终视频文件的名称。

**5. 如何运行**

1.  打开终端。
2.  使用 `cd` 命令切换到包含所有文件（图片、音频、脚本）的目录。
3.  确保你已经根据需要修改了脚本的配置部分，并且已经赋予了脚本执行权限 (`chmod +x create_ebook_video.sh`)。
4.  执行脚本： `./create_ebook_video.sh`
5.  脚本将开始执行，并在终端输出处理进度信息。
    * 创建每个图片/音频对的临时视频片段。
    * 创建用于合并的列表文件。
    * 合并片段生成最终视频。
    * 清理临时文件。
6.  执行成功后，你将在当前目录下找到由 `OUTPUT_VIDEO` 变量指定的最终视频文件（默认为 `ebook_video.mp4`）。

**6. 错误处理与故障排查**

* **`./create_ebook_video.sh: command not found`**: 脚本文件不存在于当前目录，或者没有执行权限。请检查文件名和路径，并使用 `chmod +x create_ebook_video.sh`。
* **`ffmpeg: command not found`**: 未安装 FFmpeg 或其路径未包含在系统的 `PATH` 环境变量中。请参考第 3 节安装 FFmpeg。
* **`错误：图片文件 '...' 未找到` 或 `错误：音频文件 '...' 未找到`**: 脚本中配置的文件名与实际文件名不符，或者文件不在脚本所在的目录中。请检查 `IMAGES` 和 `AUDIO_FILES` 数组中的文件名拼写和扩展名，并确认文件存在。
* **`错误：图片文件数量 (...) 与音频文件数量 (...) 不匹配`**: `IMAGES` 数组和 `AUDIO_FILES` 数组中的元素数量不同。请检查并确保两者包含相同数量的文件名，且一一对应。
* **脚本中途失败，提示 FFmpeg 相关错误**:
    * 可能是输入的图片或音频文件格式不受支持或已损坏。尝试用其他工具打开这些文件检查。
    * 可能是 FFmpeg 版本过旧，不支持脚本中使用的某些选项（尽管脚本使用了相对通用的选项）。尝试更新 FFmpeg。
    * 可能是磁盘空间不足，无法写入临时文件或输出文件。
* **生成的视频播放异常 (如只有声音无图像，或颜色不正确)**:
    * 脚本中使用了 `-pix_fmt yuv420p` 来提高兼容性。如果仍有问题，可能是播放器兼容性问题，尝试更换播放器 (如 VLC)。
    * 确认源图片文件本身没有问题。
* **权限错误 (Permission denied)**: 脚本没有足够的权限在当前目录创建文件（临时片段、列表文件、输出视频）或读取输入文件。检查目录和文件的权限。

**7. 注意事项**

* 脚本默认会覆盖同名的输出文件 (`OUTPUT_VIDEO`) 和临时文件，而不会提示。
* 处理大量或高分辨率文件可能需要较长时间和较多计算资源。
* 脚本生成的视频编码参数（如 `-c:v libx264`, `-c:a aac`, `-b:a 192k`, `-preset medium`）是为了通用性和较好的兼容性。高级用户可以根据需要修改 `ffmpeg` 命令参数以调整输出质量、文件大小和编码速度。
* 对于非常旧的 FFmpeg 版本（例如 2.x 或更早），某些选项（如 `-tune stillimage`）可能不可用或行为不同。推荐使用较新版本的 FFmpeg (版本 4.x 或更高)。

---

## 测试与验收流程 for `create_ebook_video.sh`

**1. 测试目标**

验证 `create_ebook_video.sh` 脚本在不同的环境配置下能够稳定、正确地完成其核心功能（合并图片和音频为视频），并能按预期处理常见的错误情况。

**2. 测试范围**

* **核心功能:** 成功生成包含所有图片和音频片段的视频。
* **配置灵活性:** 不同数量的文件、不同格式的图片/音频文件（在 FFmpeg 支持范围内）。
* **环境兼容性:** 在主流 Linux 发行版、不同 Shell 环境（主要 Bash）以及不同 FFmpeg 版本下的基本运行情况。
* **错误处理:** 验证脚本对文件丢失、配置错误等情况的捕获和报告。

**3. 测试环境**

理想情况下，应在以下组合环境中进行测试：

* **Linux 发行版:**
    * Ubuntu LTS (例如 20.04, 22.04)
    * Fedora (最新稳定版)
    * Debian (最新稳定版)
    * CentOS / RHEL / AlmaLinux / Rocky Linux (例如 8, 9)
* **Shell 环境:**
    * Bash (主要测试目标，版本 4.x 或 5.x)
    * Zsh (作为次要兼容性检查)
* **FFmpeg 版本:**
    * 较新稳定版 (例如 FFmpeg 5.x, 6.x)
    * 较旧但仍常见的版本 (例如 FFmpeg 4.x，通常在一些 LTS 发行版中默认提供)

**4. 测试准备**

* 准备多组测试用的图片文件（包括 `.jpg`, `.png`, `.jpeg` 格式）。
* 准备多组测试用的音频文件（包括 `.mp3`, `.wav`, `.aac` 格式）。
* 确保测试环境安装了对应版本的 `ffmpeg` 和 `bash`。
* 将脚本和测试媒体文件放置在测试环境的指定目录中。

**5. 测试用例**

| 用例 ID | 测试描述                     | 测试环境/前提条件                                       | 测试步骤                                                                                             | 预期结果                                                                                                                               |
| :------ | :--------------------------- | :------------------------------------------------------ | :--------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------- |
| **TC01** | **基本功能 (Happy Path)** | 标准环境 (如 Ubuntu LTS, Bash, FFmpeg 5.x), 5 个 JPG 图片, 5 个 MP3 音频, 使用默认配置 | 1. 放置文件。 2. `chmod +x create_ebook_video.sh`。 3. `./create_ebook_video.sh`。                    | 脚本成功执行，无错误。生成 `ebook_video.mp4` 文件。视频内容按顺序包含 5 个图片及其对应音频。临时文件 (`segment_*.mp4`, `mylist.txt`) 被删除。 |
| **TC02** | **不同文件数量** | 同上, 修改脚本配置为 3 个图片和 3 个音频文件                 | 1. 修改 `IMAGES` 和 `AUDIO_FILES` 数组。 2. 运行脚本。                                             | 脚本成功执行。生成包含 3 个片段的视频。                                                                                             |
| **TC03** | **不同图片格式** | 同上, 使用包含 `.jpg`, `.png`, `.jpeg` 的图片文件列表          | 1. 修改 `IMAGES` 数组指向不同格式图片。 2. 运行脚本。                                                | 脚本成功执行。生成的视频能正常显示所有不同格式的图片。                                                                               |
| **TC04** | **不同音频格式** | 同上, 使用包含 `.mp3`, `.wav`, `.aac` 的音频文件列表         | 1. 修改 `AUDIO_FILES` 数组指向不同格式音频。 2. 运行脚本。                                           | 脚本成功执行。生成的视频能正常播放所有片段的音频 (因为片段创建时统一编码为 AAC)。                                                        |
| **TC05** | **输入文件丢失 (图片)** | 同上, 脚本配置指向一个实际不存在的图片文件                   | 1. 运行脚本。                                                                                         | 脚本执行失败，输出明确的错误信息，如 `错误: 图片文件 '...' 未找到。`，并提前退出。                                                          |
| **TC06** | **输入文件丢失 (音频)** | 同上, 脚本配置指向一个实际不存在的音频文件                   | 1. 运行脚本。                                                                                         | 脚本执行失败，输出明确的错误信息，如 `错误: 音频文件 '...' 未找到。`，并提前退出。                                                          |
| **TC07** | **配置错误 (数量不匹配)** | 同上, 修改脚本使 `IMAGES` 和 `AUDIO_FILES` 数组长度不同       | 1. 运行脚本。                                                                                         | 脚本执行失败，输出明确的错误信息，如 `错误：图片文件数量 (...) 与音频文件数量 (...) 不匹配。`，并提前退出。                                    |
| **TC08** | **配置错误 (无文件)** | 同上, 修改脚本使 `IMAGES` 和 `AUDIO_FILES` 数组为空          | 1. 运行脚本。                                                                                         | 脚本执行失败，输出明确的错误信息，如 `错误：未指定图片或音频文件。`，并提前退出。                                                        |
| **TC09** | **依赖缺失 (FFmpeg)** | 在未安装 FFmpeg 或将其从 PATH 移除的环境下运行                 | 1. 运行脚本。                                                                                         | 脚本执行失败，输出类似 `ffmpeg: command not found` 的错误信息（可能因系统而异）。                                                         |
| **TC10** | **不同 Shell 环境 (zsh)** | 在安装了 `zsh` 的环境运行                               | 1. `zsh ./create_ebook_video.sh`                                                                     | 预期脚本能成功执行（因为使用的命令和 bash 语法大多兼容 zsh）。如果失败，记录具体错误。                                                 |
| **TC11** | **不同 FFmpeg 版本** | 在安装了较旧 FFmpeg 版本 (如 4.x) 的环境运行               | 1. `./create_ebook_video.sh`                                                                         | 预期脚本能成功执行。注意观察是否有弃用选项的警告，但不影响结果。                                                                       |
| **TC12** | **输出文件已存在** | 运行 TC01 成功后，不删除输出文件，再次运行脚本              | 1. `./create_ebook_video.sh`                                                                         | 脚本成功执行，覆盖已存在的 `ebook_video.mp4` 文件（因为 `ffmpeg` 命令中隐含了 `-y` 选项或默认行为是覆盖）。                               |
| **TC13** | **无写入权限** | 在一个用户没有写入权限的目录中尝试运行脚本                  | 1. `cd /path/to/readonly_dir` 2. 将脚本和文件复制到此。 3. `./create_ebook_video.sh`                 | 脚本执行失败，输出与文件写入相关的 "Permission denied" 错误（发生在尝试创建 segment 文件或 list 文件时）。                               |

**6. 测试执行**

* 按照测试用例逐一执行。
* 在不同的目标环境（Linux 发行版、Shell、FFmpeg 版本）上重复关键测试用例（如 TC01, TC05, TC06, TC09, TC11）。
* 记录每个测试用例的实际结果，与预期结果进行比较。
* 对于失败的测试用例，记录详细的错误信息、环境配置和复现步骤。

**7. 验收标准**

* 所有标记为**核心功能**和**错误处理**的测试用例 (TC01, TC02, TC03, TC04, TC05, TC06, TC07, TC08, TC12, TC13) 在主要目标环境（例如 Ubuntu LTS + Bash + 最新 FFmpeg）下必须通过。
* **环境兼容性**测试用例 (TC10, TC11) 应能成功运行或明确记录其不兼容性及原因。脚本主要保证在 `bash` 下运行。
* **依赖缺失**测试用例 (TC09) 必须按预期失败并给出可识别的错误信息。
* 所有失败的测试用例都应有对应的缺陷报告，并评估其严重性。关键缺陷修复后需要进行回归测试。
* 最终生成的视频文件在标准播放器（如 VLC）上能正常播放，音画同步，内容符合输入。

---